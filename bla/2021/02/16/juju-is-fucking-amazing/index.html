<!DOCTYPE html>
<html lang="en">

	<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

	<!-- custom css AFTER bootstrap -->
	<link href="https://fonts.googleapis.com/css?family=Noto+Serif&amp;subset=greek-ext,latin-ext" rel="stylesheet">
	<link rel="stylesheet" href="/assets/css/cover.css">
	<link rel="stylesheet" href="/assets/css/solarized-dark.css">

	<link rel="icon" type="image/png" href="/assets/favicon.png">
	<title>Juju is Fucking Amazing</title>
	<meta name="description" content="">

	<!-- Facebook/Twitter/SEO -->
	<meta property="og:title" content="Juju is Fucking Amazing"/>
	<meta property="og:image" content="https://heitorpb.github.io/bla/2021/02/16/juju-is-fucking-amazing/cthulhu.png"/>
	<meta property="og:url" content="https://heitorpb.github.io/bla/2021/02/16/juju-is-fucking-amazing/"/>
	<meta property="og:type" content="article">
	<meta property="og:site_name" content="Heitor's log"/>
	<meta property="og:description" content="Yeaah"/>

	<meta name="twitter:card" content="summary">
	<meta name="twitter:site" content="">
	<meta name="twitter:title" content="Juju is Fucking Amazing" />
	<meta name="twitter:image" content="https://heitorpb.github.io/bla/2021/02/16/juju-is-fucking-amazing/cthulhu.png" />
	<meta name="twitter:url" content="https://heitorpb.github.io/bla/2021/02/16/juju-is-fucking-amazing/" />
	<meta name="twitter:description" content="Yeaah" />

	<link rel="sitemap" type="application/xml" title="Sitemap" href="https://heitorpb.github.io/sitemap.xml" />
	<link rel="alternate" type="application/rss+xml" href="https://heitorpb.github.io/feed.xml">
</head>


	<body>
		<div id="wrapper">

			<div class="cover-container d-flex w-100 h-100 p-3 mx-auto flex-column">
	<header class="masthead mb-auto">
		<div class="inner">
			<h3 class="masthead-brand">Heitor&#39;s log</h3>
			<nav class="nav nav-masthead justify-content-center">
				<a class="nav-link "    href="/"             >Home</a>
				<a class="nav-link "       href="/me.html"      >Me</a>
				<a class="nav-link " href="/projects.html">Projects</a>
				<a class="nav-link active"     href="/bla/"         >Bla</a>
			</nav>
		</div>
	</header>


			<main role="main" class="inner cover">
				<br>
				<article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">
	<header class="post-header">
		<h1 class="post-title p-name" itemprop="name headline">Juju is Fucking Amazing</h1>
		<p class="post-meta">
			<time class="dt-published" datetime="2021-02-16T00:00:00-03:00" itemprop="datePublished">Feb 16, 2021
			</time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Heitor</span></span></p>
	</header>

	<br>

	<div class="post-content e-content" itemprop="articleBody">
		<p>I’m working with <a href="https://juju.is">juju</a> to manage High Performance Computing clusters. It is an interesting software, but with horrible documentation. And of course, easter eggs are not documented.</p>

<p>After all, that’s why <em>easter eggs</em> have this name: they are secret features.</p>

<p>Last Friday, just a few minutes before ending the week, my boss told me “<em>Do
you know what <code class="highlighter-rouge">juju is</code>? Find out how this command works.</em>”. At first, I didn’t
get the question. I’ve been working with <code class="highlighter-rouge">juju</code> for a few days, I have an idea
of what <em>it is</em>. Instead, I was supposed to type in the terminal:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>juju is
fucking amazing
</code></pre></div></div>

<p>So, <code class="highlighter-rouge">juju</code> has a very high self-esteem. Now that I know <em>what <code class="highlighter-rouge">juju is</code></em>, I
need to find out <em>how</em> this command works. Let’s ask for help:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>juju is <span class="nt">--help</span>
ERROR juju: <span class="s2">"is"</span> is not a juju command. See <span class="s2">"juju --help"</span><span class="nb">.</span>

Did you mean:
        ssh
<span class="nv">$ </span><span class="nb">echo</span> <span class="nv">$?</span>
1
</code></pre></div></div>

<p>Hmmm, looks like this command is quite hidden. Time to get the source and look
around:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>git clone git@github.com:juju/juju.git
<span class="nv">$ </span><span class="nb">cd </span>juju
<span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-iRn</span> <span class="nt">--exclude-dir</span><span class="o">=</span>.git fuck
</code></pre></div></div>

<p>Hmmm. The string <code class="highlighter-rouge">fuck</code> is not in the repository. So, it is not just “quite
hidden”, they obscured it. I liked the challenge! Where to start searching, and
what to search for? They probably wrote that string in binary, or in something
weirder. There are too many files in this source code to go through everything,
we need another strategy.</p>

<p>Let’s start looking for that <code class="highlighter-rouge">is not a juju command</code> error-string:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">grep</span> <span class="nt">-iRn</span> <span class="nt">--exclude-dir</span><span class="o">=</span>.git <span class="s2">"is not a juju command"</span>
cmd/juju/commands/repl_test.go:207:ERROR juju: <span class="s2">"foo"</span> is not a juju command. Type <span class="s2">"help"</span> to see a list of commands.
cmd/juju/commands/main.go:236:const notFoundCommandMessage <span class="o">=</span> <span class="sb">`</span>juju: %q is not a juju command. %s.
cmd/juju/commands/plugin_test.go:163:   expectedHelp :<span class="o">=</span> <span class="sb">`</span>ERROR juju: <span class="s2">"foo"</span> is not a juju command. See <span class="s2">"juju --help"</span><span class="nb">.</span>
cmd/juju/commands/plugin_test.go:173:   expectedHelp :<span class="o">=</span> <span class="sb">`</span>ERROR juju: <span class="s2">"/foo"</span> is not a juju command. See <span class="s2">"juju --help"</span><span class="nb">.</span>
cmd/juju/commands/plugin_test.go:183:   expectedHelp :<span class="o">=</span> <span class="sb">`</span>ERROR juju: <span class="s2">".foo"</span> is not a juju command. See <span class="s2">"juju --help"</span><span class="nb">.</span>
<span class="nb">grep</span>: testcharms/charm-repo/series/format2/hooks/symlink: No such file or directory
</code></pre></div></div>

<p>The file <code class="highlighter-rouge">cmd/juju/commands/main.go</code> appears to be an interesting starting
point, after all it is the file that parses the command line arguments! Just in
the beginning, there’s a very suspicious line (78):</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">(</span><span class="s">"</span><span class="se">\x96\x8c\x8a\x91\x93\x9a\x9e\x8c\x97\x99\x8a\x9c\x94\x96\x91\x98\xdf\x9e\x92\x9e\x85\x96\x91\x98\xf5</span><span class="s">"</span><span class="p">)</span>
</code></pre></div></div>

<p>What the hell? Looking for this variable in the file shows something
interesting on lines 126-138:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">x</span> <span class="p">{</span>
		<span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="m">255</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="m">2</span> <span class="p">{</span>
		<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">==</span> <span class="kt">string</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="m">0</span><span class="o">:</span><span class="m">2</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="m">9</span><span class="o">:</span><span class="p">])</span>
			<span class="k">return</span> <span class="m">0</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">==</span> <span class="kt">string</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="m">9</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">os</span><span class="o">.</span><span class="n">Stdout</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">ExtractCert</span><span class="p">())</span>
			<span class="k">return</span> <span class="m">0</span>
		<span class="p">}</span>
	<span class="p">}</span>
</code></pre></div></div>

<p>This variable is XORed with <code class="highlighter-rouge">255</code> and the CLI arguments are compared with parts
of it, casted to string. That’s too suspicious. I made a quick C++ code to find
out what that weird byte sequence XORed with <code class="highlighter-rouge">255</code> is:</p>

<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include &lt;vector&gt;
#include &lt;iostream&gt;
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">x</span> <span class="p">{</span><span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x93</span><span class="p">,</span> <span class="mh">0x9a</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span>
	                          <span class="mh">0x8c</span><span class="p">,</span> <span class="mh">0x97</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span> <span class="mh">0x8a</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span>
	                          <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xdf</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x9e</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span>
	                          <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x91</span><span class="p">,</span> <span class="mh">0x98</span><span class="p">,</span> <span class="mh">0xf5</span><span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="n">i</span><span class="o">:</span> <span class="n">x</span><span class="p">)</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="s">" "</span><span class="p">;</span>
	<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="n">i</span><span class="o">:</span> <span class="n">x</span><span class="p">)</span>
		<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;</span><span class="p">(</span><span class="n">i</span><span class="o">^</span><span class="mi">255</span><span class="p">);</span>
	<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>It starts with some standard libraries, that weird byte sequence written the
C++ way, prints the sequence, prints the sequence XORed with <code class="highlighter-rouge">255</code> as a char,
and returns:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>g++ weird.cpp
<span class="nv">$ </span>./a.out
150 140 138 145 147 154 158 140 151 153 138 156 148 150 145 152 223 158 146 158 133 150 145 152 245
isunleashfucking amazing
</code></pre></div></div>

<p>HA, that’s it! That weird byte sequence is <code class="highlighter-rouge">isunleashfucking amazing</code>. Lines
130-133 of the <code class="highlighter-rouge">main.go</code> file compare the CLI argument with the first 2 chars
of this string (<code class="highlighter-rouge">is</code>) and, if it matches, it prints the chars starting from
index 9 until the end (<code class="highlighter-rouge">fucking amazing</code>). Nice!</p>

<p>By XORing with <code class="highlighter-rouge">255</code> it is not possible to <code class="highlighter-rouge">grep</code> the source for that string,
so it keeps it as a secret.</p>

<p>And there’s more. Lines 134-137 compare the input to <code class="highlighter-rouge">x[2:9]</code>: <code class="highlighter-rouge">unleash</code>. So
there’s another easter egg!</p>

<p><img src="cthulhu.png" alt="&quot;juju unleash&quot; command prints out Cthulhu ASCII art" title="Juju unleashes Cthulhu" /></p>

<p>And <em>this</em> was amazing! You can manage HPC clusters and unleash Cthulhu at the
same time!</p>

<p>I like to try to understand <em>how</em> stuff works. We always learn something new
this way. This <em>something</em> can be anything: a cool programming trick, a new
algorithm, a better way to structure our code, and even an easter egg! The sky
is the limit.</p>

<p>Btw, Cthulhu is in the file <code class="highlighter-rouge">cmd/juju/model/data.go</code>, XORed with <code class="highlighter-rouge">255</code> for
safety.</p>

	</div>

	<a class="u-url" href="/bla/2021/02/16/juju-is-fucking-amazing/" hidden></a>
</article>
				<br>
			</main>

				<footer class="mastfoot mt-auto text-center">
		<div class="inner">
			
			<br />Heitor's log, 2018 - 2021
			by <a href="/me.html">Heitor</a>
			is licensed under a
			<a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0 International License</a>.
		</div>
	</footer>
</div>
			<script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-MML-AM_CHTML' async></script>
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

		</div>
	</body>
</html>